# ibm-wcd-redis

[Redis](https://redis.io) is an open source (BSD licensed), in-memory data structure store, used as a database, cache and message broker.

## Introduction

This chart bootstraps a high availability [Redis](https://redis.io) deployment on a [Kubernetes](http://kubernetes.io) cluster using the [Helm](https://helm.sh) package manager.

## Chart Details

The customized Redis server image determines whether the pod that executes it will be a Redis Sentinel,
Master, or Slave and launches the appropriate service. This Helm chart signals Sentinel status with
environment variables. If not set, the newly launched pod will query K8S for an active master. If none
exists, it uses a deterministic means of sensing whether it should launch as master then writes "master"
or "slave" to the label called redis-role as appropriate. It's this label that determines which LB a pod
can be seen through.

The redis-role=master pod is the key for the cluster to get started. Sentinels will wait for it to appear
in the LB before they finish launching. All other pods wait for the Sentinels to ID the master. Running
Pods also set the labels podIP and runID. runID is the first few characters of the unique run_id value
generated by each Redis sever.

During normal operation, there should be only one redis-role=master pod. If it fails, the Sentinels
will nominate a new master and change all the redis-role values appropriately.

To see the pod roles, run the following:

```shell
kubectl get pods -L redis-role
```

By default this chart installs 1 master, 2 slaves and 3 sentinels.

## Prerequisites

- Kubernetes 1.7+ with Beta APIs enabled
- Tiller 2.7.2 or later
- PV support on the underlying infrastructure
- Persistent Volume is required if persistance is enabled You can create a persistent volume via the IBM Cloud Private interface or through a yaml file.


## Configuration

The following tables lists the configurable parameters of the Redis chart and their default values.

| Parameter                        | Description                                           | Default                                                   |
| -------------------------------- | ----------------------------------------------------- | --------------------------------------------------------- |
| `arch.amd64`                     | Preference to run on amd64 architecture               | `2 - No preference`                                       |
| `arch.ppc64le`                   | Preference to run on ppc64le architecture             | `2 - No preference`                                       |
| `image.repository`               | Redis image repo                                      | `registry.ng.bluemix.net/icp-common-components/redis-ha`  |
| `image.tag`                      | Redis image tag                                       | `3.2.12-v0.0.24`                                          |
| `image.pullPolicy`               | Redis image pull policy                               | `IfNotPresent`                                            |
| `pullSecret`                     | Redis image pull secret to download the image         | `us-south-redsonja-token`                                 |
| `password`                       | Password for redis user                               | `redispassword`                                           |
| `passwordTemplate`               | Helm template used to render the password. Usefull only if used a subchart. | ``                                  |
| `cachemode`					   | To Deploy redis in cache mode set as `yes`				   | `no`										   |
| `maxmemory`					   | Maximum memory allocation for redis in bytes							   | `100mb`										   |
| `maxmemory_policy`					   | eviction policy after reaching maxmemory							   | `allkeys-lru`										   |
| `appendonly`					   | Enable AOF						   | `yes`										   |
| `timeout`					   | Close the connection after a client is idle for N seconds (0 to disable)							   | `0`										   |
| `tcp_keepalive`					   | Send TCP ACKs to clients every N seconds in absence of communication							   | `300`										   |
| `lua_time_limit`					   | Max execution time of a Lua script in milliseconds							   | `5000`										   |
| `slowlog_log_slower_than`					   | The execution time, in microseconds, that commands must exceed in order to get logged in the slowlog							   | `10000`										   |
| `slowlog_max_len`					   | The maximum length of the slow log							   | `120`										   |
| `replicas.servers`               | Number of redis master/slave pods                     | `2`                                                       |
| `replicas.sentinels`             | Number of sentinel pods                               | `3`                                                       |
| `serverService.type`             | Set to "LoadBalancer" to enable access from the VPC   | `ClusterIP`                                               |
| `rbac.create`                    | Create a RBAC resource                                | `true`                                                    |
| `serviceAccount.create`          | Create a service account                              | `true`                                                    |
| `serviceAccount.name`            | Service account name to use. The chart template _fullname_ is used if blank. | _chart template _fullname_        |
| `master.livenessProbe.enabled`              | Enable master node liveness probes                                                           | `true`   |
| `master.livenessProbe.initialDelaySeconds`  | Number of seconds after the container has started before the probe is initiated.             | `60`     |
| `master.livenessProbe.periodSeconds`        | How often (in seconds) to perform the probe.                                                 | `10`     |
| `master.livenessProbe.timeoutSeconds`       | Number of seconds after which the probe times out.                                           | `5`      |
| `master.livenessProbe.successThreshold`     | Minimum consecutive successes for the probe to be considered successful after having failed. | `1`      |
| `master.livenessProbe.failureThreshold`     | Number of failures to accept before giving up and marking the pod as Unready.                | `5`      |
| `master.readinessProbe.enabled`             | Enable master node readiness probes                                                          | `true`   |
| `master.readinessProbe.initialDelaySeconds` | Number of seconds after the container has started before the probe is initiated.             | `15`     |
| `master.readinessProbe.periodSeconds`       | How often (in seconds) to perform the probe.                                                 | `10`     |
| `master.readinessProbe.timeoutSeconds`      | Number of seconds after which the probe times out.                                           | `3`      |
| `master.readinessProbe.successThreshold`    | Minimum consecutive successes for the probe to be considered successful after having failed. | `1`      |
| `master.readinessProbe.failureThreshold`    | Number of failures to accept before giving up and marking the pod as Unready.                | `3`      |
| `sentinel.livenessProbe.enabled`              | Enable sentinel node liveness probes                                                         | `true`   |
| `sentinel.livenessProbe.initialDelaySeconds`  | Number of seconds after the container has started before the probe is initiated.             | `60`     |
| `sentinel.livenessProbe.periodSeconds`        | How often (in seconds) to perform the probe.                                                 | `10`     |
| `sentinel.livenessProbe.timeoutSeconds`       | Number of seconds after which the probe times out.                                           | `5`      |
| `sentinel.livenessProbe.successThreshold`     | Minimum consecutive successes for the probe to be considered successful after having failed. | `1`      |
| `sentinel.livenessProbe.failureThreshold`     | Number of failures to accept before giving up and marking the pod as Unready.                | `5`      |
| `sentinel.readinessProbe.enabled`             | Enable sentinel node readiness probes                                                        | `true`   |
| `sentinel.readinessProbe.initialDelaySeconds` | Number of seconds after the container has started before the probe is initiated.             | `15`     |
| `sentinel.readinessProbe.periodSeconds`       | How often (in seconds) to perform the probe.                                                 | `10`     |
| `sentinel.readinessProbe.timeoutSeconds`      | Number of seconds after which the probe times out.                                           | `3`      |
| `sentinel.readinessProbe.successThreshold`    | Minimum consecutive successes for the probe to be considered successful after having failed. | `1`      |
| `sentinel.readinessProbe.failureThreshold`    | Number of failures to accept before giving up and marking the pod as Unready.                | `3`      |
| `resources.server.requests.memory`   | Server memory resource requests                     | `200Mi`        |
| `resources.server.requests.cpu`      | Server CPU resource requests                        | `100m`         |
| `resources.server.limits.memory`     | Server Memory resource limits                       | `700Mi`        |
| `resources.server.limits.cpu`        | Server CPU resource limits                          | `100m`         |
| `resources.sentinel.requests.memory` | Sentinel memory resource requests                   | `200Mi`        |
| `resources.sentinel.requests.cpu`    | Sentinel CPU resource requests                      | `100m`         |
| `resources.sentinel.limits.memory`   | Sentinel Memory resource limits                     | `200Mi`        |
| `resources.sentinel.limits.cpu`      | Sentinel CPU resource limits                        | `100m`         |

Specify each parameter using the `--set key=value[,key=value]` argument to `helm install`. For example,


The above command sets the Redis server within  `default` namespace.

Alternatively, a YAML file that specifies the values for the parameters can be provided while installing the chart. For example,


> **Tip**: You can use the default [values.yaml](values.yaml)

## Features

- Supports redis version 3.2.12 only with the mentioned image
- Supports Authentication 
- Supports High Availability 
- Supports Redis Cache Mode 
- Supports Configuration Paramters to be passed while installing 
- Supports to restore data from rdb file

## Limitations

- No SSL support as Redis does not support SSL
- The chart does not support the s390x architecture.
 
## Resources Required

The chart deploys pods consuming minimum resources as specified in the resources configuration parameter (default: Memory: 200Mi, CPU: 100m)

## Persistent Volume
You can create a persistent volume via the IBM Cloud Private interface or through a yaml file. For example:
```
apiVersion: v1
kind: PersistentVolume
metadata:
  name: <persistent volume name>
spec:
  capacity:
    storage: 8Gi
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  storageClassName: standard
  hostPath:
    path: /tmp
```
## Installing the Chart

Clone this repo and execute the below command from the root directory of it.

```
helm install .  --name <releasename> --tls
```
or
```
helm install ibm-wcd-redis-0.0.6.tgz --name <releasename> --tls
```


## Verifying the Chart

- To list the resources created by this chart use the flag
`-l release=<releasename>`

- To list the redis-role of the pods deployed by this chart use the below command

```
kubectl get pods -l release=<releasename> -L redis-role
```

- To test connection execute bash in any of the redis containers in the same cluster as the redis deployment

```
$ kubectl exec -it <podname> bash

$ redis-cli -h  <releasename>-ibm-wcd-redis-master-svc -a <password>

> set <key> <value>
> get <key>
```

## Uninstalling the Chart

```
helm delete <releasename> --purge --tls
```
The command removes all the Kubernetes components associated with the chart and deletes the release.

## Backup & Restore 

**To Backup:**

dump.rdb is updated periodically, to get the current data in your backup save it before taking backup. 
```
$ redis-cli -h  <releasename>-ibm-wcd-redis-master-svc -a <password>

> save
```

Simply copy the dump.rdb file from redis master pod and store it in your desired place. 
```
$ kubectl cp <namespace>/<podname>:/redis-master-data/dump.rdb local/path/dump.rdb
```

**To Restore:**
 
Restore data in a new deployment, if not the data available before the restoration process in the deployment will be lost after the restoration process. 

1. Need to create a new redis deployment with the following configuration. 

- Persistent Volume enabled.
- AOF disabled (set parameter `appendonly no` )

2. Copy the dump file to all of your redis server pods that belongs to that release

```
$ kubectl cp local/path/dump.rdb <namespace>/<podname>:/redis-master-data/dump.rdb 
```

3. After copying the dump file to each redis server pods that belongs to that release, Delete all the redis server pods 

```
$ kubectl delete pod <podname>
```

4. Wait till all the redis pods are recreated and then connect to redis master service 

```
$ redis-cli -h  <releasename>-ibm-wcd-redis-master-svc -a <password>

> keys *
```

  verify the data is restored

5. Enable AOF

```
> config set appendonly yes
> config get appendonly
```
